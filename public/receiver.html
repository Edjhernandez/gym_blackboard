<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WOD Trainer Receiver</title>
    <!-- Mandatory loading of the Cast receiver framework -->
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <link rel="stylesheet" href="receiverStyles.css" />
  </head>
  <body>
    <div id="message-box">
      <img src="/assets/images/180logo.png" alt="Center Fitness Logo" />
      <h1>Gym Fitness Center</h1>
      <div id="waiting">Esperando rutina</div>
    </div>
    <div id="routine-container" class="is-hidden"></div>
    <button id="close-button">boton</button>

    <script>
      const routineOfTest = {
        userId: "y8eDfuav5cOGpBgTDgIbtscreLq2",
        warmup: [
          {
            sets: 1,
            name: "Torso twist",
            exerciseType: "warmup",
            reps: 20,
            id: "2esO3IceqSAm9asCcKjN",
          },
        ],
        durationMinutes: 22,
        id: "4FSPlJAU8iBResksFZrw",
        isFavorite: false,
        blocks: [
          {
            title: "Bloque 1",
            id: "2cdbfa46-e929-4d1b-af70-b73893bf9823",
            exercises: [
              {
                exerciseType: "functional",
                sets: 1,
                videoURL:
                  "https://firebasestorage.googleapis.com/v0/b/gymblackboard.firebasestorage.app/o/pushUp.mp4?alt=media&token=4e4a9401-16bd-4b0d-82bc-12d1aad27005",
                id: "Xuv4WBTEr233on8t5FZS",
                reps: 10,
                name: "Push-up",
                bodyPart: "chest",
              },
              {
                sets: 1,
                bodyPart: "back",
                reps: 20,
                id: "14gtBPclrLYmbwVgsIdd",
                name: "Remo con liga",
                exerciseType: "functional",
              },
            ],
          },
          {
            title: "Bloque 2",
            id: "32203a26-f219-4661-bc33-9757ef454999",
            exercises: [
              {
                sets: 2,
                name: "Plank",
                reps: 10,
                bodyPart: "abs",
                id: "9WMDYoM28vYYLIPMy1j8",
                exerciseType: "functional",
                videoURL:
                  "https://firebasestorage.googleapis.com/v0/b/gymblackboard.firebasestorage.app/o/plank.mp4?alt=media&token=ddf97c85-190e-4818-a389-fead6a212b90",
              },
              {
                reps: 20,
                exerciseType: "functional",
                id: "ShwBVJHUUhYroKDE5qBr",
                bodyPart: "legs",
                sets: 1,
                name: "Air squat",
              },
            ],
          },
        ],
        exercisesAmount: 4,
        createdAt: {
          type: "firestore/timestamp/1.0",
          seconds: 1765030552,
          nanoseconds: 259000000,
        },
        name: "Ruti tres",
        category: "functional",
      };

      function renderRoutine(routine) {
        const messageBox = document.getElementById("message-box");
        const routineContainer = document.getElementById("routine-container");
        messageBox.classList.add("is-hidden");
        routineContainer.classList.remove("is-hidden");
        routineContainer.innerHTML = `
        <div class="routine-header">
          <div class="logo-container">
          <img src="/assets/images/180logo.png" alt="Center Fitness Logo" />
          <h3>GFC</h3>
          </div>
          </div>
          <h1>${routine.name}</h1>
          <h2>${routine.exercisesAmount} Ejercicios - ${routine.durationMinutes} minutos</h2>
          ${routine.blocks
            .map(
              (block) => `
            <div class="block">
              <h3>${block.title}</h3>
              <ul>
                ${block.exercises
                  .map((exercise) => {
                    let videoHtml = "";
                    if (exercise.videoURL) {
                      videoHtml = `
                                    <div class="video-container shadow-xl border border-slate-700">
                                        <video autoplay loop muted playsinline with="20" height="20">
                                            <source src="${exercise.videoURL}" type="video/mp4">
                                        </video>
                                    </div>
                                `;
                    }
                    return `
                          <li>
                            <strong>${exercise.name}</strong> - ${exercise.sets} sets de ${exercise.reps} reps
                            ${videoHtml}
                          </li>
                        `;
                  })
                  .join("")}
                  
                      </ul>
                    </div>
                  `
            )
            .join("")}
                `;
      }

      const button = document.getElementById("close-button");

      button.addEventListener("click", () => {
        console.log("BotÃ³n presionado");
        renderRoutine(routineOfTest);
      });
      //const CUSTOM_NAMESPACE = "urn:x-cast:1F7E2448";
      //const context = cast.framework.CastReceiverContext.getInstance();

      // Config to avoid auto-shutdown
      const options = new cast.framework.CastReceiverOptions();
      options.disableIdleTimeout = true;
      options.resumeSavedSession = true;

      // Listener for sender disconnection
      context.addEventListener(
        cast.framework.system.EventType.SENDER_DISCONNECTED,
        (event) => {
          console.log("Sender desconectado, cerrando...");
          if (context.getSenders().length === 0) {
            window.close();
          }
        }
      );

      // Listener for sent routines
      context.addCustomMessageListener(CUSTOM_NAMESPACE, (event) => {
        let routine = event.data.text;
        if (typeof routine === "string") {
          try {
            routine = JSON.parse(routine);
          } catch (e) {
            console.error("Error al parsear la rutina recibida:", e);
            return;
          }
        }
        renderRoutine(routine);
      });

      context.start(options);
    </script>
  </body>
</html>
