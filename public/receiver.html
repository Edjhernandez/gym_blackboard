<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WOD Trainer Receiver</title>
    <!-- Mandatory loading of the Cast receiver framework -->
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <link rel="stylesheet" href="receiverStyles.css" />
  </head>
  <body>
    <div id="message-box">
      <img src="/assets/images/180logo.png" alt="Center Fitness Logo" />
      <h1>Gym Fitness Center</h1>
      <div id="waiting">Esperando rutina</div>
    </div>
    <div id="routine-container" class="is-hidden"></div>
    <!-- <button id="close-button">boton</button> -->

    <script>
      function renderRoutine(routine) {
        const messageBox = document.getElementById("message-box");
        const routineContainer = document.getElementById("routine-container");
        messageBox.classList.add("is-hidden");
        routineContainer.classList.remove("is-hidden");

        routineContainer.innerHTML = `
        <div class="routine-header">
            <div class="coach-info">
              <img src="${routine.coachPhotoURL}" alt="${routine.coachName}" class="coach-photo" />
              <span class="coach-name">${routine.coachName}</span>
            </div>
          <img src="/assets/images/180logo.png" alt="Center Fitness Logo" />
        </div>

        
          <h1>${routine.name}</h1>
          <h2>${routine.exercisesAmount} Ejercicios - ${routine.durationMinutes} minutos</h2>
          <div class="warmup-section">
            <h2>Acondicionamiento</h2>
            <ul>
              ${routine.warmup
                .map(
                  (exercise) => `
                  <li>
                    <div>
                      <strong>${exercise.name}</strong> - ${exercise.sets} X ${exercise.reps} reps
                    </div>
                  </li>
                `,
                )
                .join("")}
            </ul>
          </div>
          ${routine.blocks
            .map(
              (block) => `
            <div class="block">
              <h3>${block.title}</h3>
              <ul>
                ${block.exercises
                  .map((exercise) => {
                    let videoHtml = "";
                    if (exercise.videoURL) {
                      videoHtml = `
                                    <div class="video-container">
                                        <video autoplay loop muted playsinline preload="auto" width="100%" height="auto" onerror="this.parentElement.innerHTML='<div class=\'error-placeholder\'>ERROR VIDEO</div>'">
                                            <source src="${exercise.videoURL}" type="video/mp4">
                                        </video>
                                    </div>
                                `;
                    }
                    return `
                          <li>
                            <div>
                              <strong>${exercise.name}</strong> - ${exercise.sets} X ${exercise.reps} reps
                              </div>
                            <div>
                              
                              ${videoHtml}
                              </div>
                          </li>
                        `;
                  })
                  .join("")}
                  
                      </ul>
                    </div>
                  `,
            )
            .join("")}
                `;
      }

      /* const button = document.getElementById("close-button");
      button.addEventListener("click", () => {
        renderRoutine(routineOfTest);
      }); */

      const CUSTOM_NAMESPACE = "urn:x-cast:1F7E2448";
      const context = cast.framework.CastReceiverContext.getInstance();

      // Config to avoid auto-shutdown
      const options = new cast.framework.CastReceiverOptions();
      options.disableIdleTimeout = true;
      options.resumeSavedSession = true;

      // Listener for sender disconnection
      context.addEventListener(
        cast.framework.system.EventType.SENDER_DISCONNECTED,
        (event) => {
          console.log("Sender desconectado, cerrando...");
          if (context.getSenders().length === 0) {
            window.close();
          }
        },
      );

      // Listener for sent routines
      context.addCustomMessageListener(CUSTOM_NAMESPACE, (event) => {
        let routine = event.data.text;
        if (typeof routine === "string") {
          try {
            routine = JSON.parse(routine);
          } catch (e) {
            console.error("Error al parsear la rutina recibida:", e);
            return;
          }
        }
        renderRoutine(routine);
      });

      context.start(options);
    </script>
  </body>
</html>
