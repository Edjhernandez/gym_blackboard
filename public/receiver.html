<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WOD Trainer Receiver</title>
    <!-- Mandatory loading of the Cast receiver framework -->
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <link rel="stylesheet" href="receiverStyles.css" />
  </head>
  <body>
    <div id="message-box">
      <img src="/assets/images/180logo.png" alt="Center Fitness Logo" />
      <h1>Gym Fitness Center</h1>
      <div id="waiting">Esperando rutina</div>
    </div>
    <div id="routine-container" class="is-hidden"></div>
    <!-- <button id="close-button">boton</button> -->

    <script>
      const routineOfTest = {
        blocks: [
          {
            title: "Bloque 1",
            id: "84dc04b5-f633-4a46-9c76-21e50e008134",
            exercises: [
              {
                id: "Xuv4WBTEr233on8t5FZS",
                bodyPart: "chest",
                reps: 20,
                videoURL:
                  "https://firebasestorage.googleapis.com/v0/b/gymblackboard.firebasestorage.app/o/exercises%2FpushUp.mp4?alt=media&token=b19b89b3-f0a9-4eb1-9f44-58ee32316754",
                name: "Push-up",
                exerciseType: "functional",
                sets: 4,
              },
              {
                exerciseType: "functional",
                reps: 20,
                bodyPart: "back",
                name: "Remo con liga",
                id: "14gtBPclrLYmbwVgsIdd",
                sets: 4,
              },
              {
                name: "Air squat",
                bodyPart: "legs",
                id: "ShwBVJHUUhYroKDE5qBr",
                sets: 4,
                exerciseType: "functional",
                reps: 20,
              },
            ],
          },
          {
            exercises: [
              {
                exerciseType: "functional",
                videoURL:
                  "https://firebasestorage.googleapis.com/v0/b/gymblackboard.firebasestorage.app/o/exercises%2Flunges.mp4?alt=media&token=ac19eb4e-9b25-4968-8274-931d454efd5c",
                id: "UwWguZ4xsKIvte4vCAxT",
                bodyPart: "legs",
                name: "Lunges",
                sets: 4,
                reps: 20,
              },
              {
                name: "Plank",
                exerciseType: "functional",
                id: "9WMDYoM28vYYLIPMy1j8",
                reps: 20,
                sets: 4,
                videoURL:
                  "https://firebasestorage.googleapis.com/v0/b/gymblackboard.firebasestorage.app/o/exercises%2Fplank.mp4?alt=media&token=6fbec338-ea8c-4eb6-92b7-8750333c8d78",
                bodyPart: "abs",
              },
            ],
            id: "a22bd9a6-f105-4b6d-9b87-2b35c70f14b3",
            title: "Bloque 2",
          },
        ],
        isFavorite: false,
        warmup: [
          {
            sets: 1,
            reps: 20,
            id: "2esO3IceqSAm9asCcKjN",
            exerciseType: "warmup",
            name: "Torso twist",
          },
          {
            sets: 1,
            name: "Movilidad de hombros",
            reps: 20,
            exerciseType: "warmup",
            id: "FYgVjy9taZB1sPsbK8rV",
          },
        ],
        durationMinutes: 41,
        exercisesAmount: 5,
        coachName: "Moisés López",
        userId: "JcXXssklDiUbZqIn2f6paYa3mwn1",
        name: "Rutina prueba",
        coachPhotoURL:
          "https://firebasestorage.googleapis.com/v0/b/gymblackboard.firebasestorage.app/o/profilePhotos%2FmoisesLopez.png?alt=media&token=12fe51bb-9ee0-44e3-acb0-712e7e554ad6",
        category: "functional",
        createdAt: {
          type: "firestore/timestamp/1.0",
          seconds: 1771244518,
          nanoseconds: 983000000,
        },
        id: "ymvz1wIkPjV9ReL7H59Z",
      };

      function renderRoutine(routine) {
        const messageBox = document.getElementById("message-box");
        const routineContainer = document.getElementById("routine-container");
        messageBox.classList.add("is-hidden");
        routineContainer.classList.remove("is-hidden");

        routineContainer.innerHTML = `
        <div class="routine-header">
            <div class="coach-info">
              <img src="${routine.coachPhotoURL}" alt="${routine.coachName}" class="coach-photo" />
              <span class="coach-name">${routine.coachName}</span>
            </div>
          <img src="/assets/images/180logo.png" alt="Center Fitness Logo" />
        </div>

        
          <h1>${routine.name}</h1>
          <h2>${routine.exercisesAmount} Ejercicios - ${routine.durationMinutes} minutos</h2>
          <div class="warmup-section">
            <h2>Acondicionamiento</h2>
            <ul>
              ${routine.warmup
                .map(
                  (exercise) => `
                  <li>
                    <div>
                      <strong>${exercise.name}</strong> - ${exercise.sets} X ${exercise.reps} reps
                    </div>
                  </li>
                `,
                )
                .join("")}
            </ul>
          </div>
          ${routine.blocks
            .map(
              (block) => `
            <div class="block">
              <h3>${block.title}</h3>
              <ul>
                ${block.exercises
                  .map((exercise) => {
                    let videoHtml = "";
                    if (exercise.videoURL) {
                      videoHtml = `
                                    <div class="video-container">
                                        <video autoplay loop muted playsinline preload="auto" width="100%" height="auto" onerror="this.parentElement.innerHTML='<div class=\'error-placeholder\'>ERROR VIDEO</div>'">>
                                            <source src="${exercise.videoURL}" type="video/mp4">
                                        </video>
                                    </div>
                                `;
                    }
                    return `
                          <li>
                            <div>
                              <strong>${exercise.name}</strong> - ${exercise.sets} X ${exercise.reps} reps
                              </div>
                            <div>
                              
                              ${videoHtml}
                              </div>
                          </li>
                        `;
                  })
                  .join("")}
                  
                      </ul>
                    </div>
                  `,
            )
            .join("")}
                `;
      }

      /* const button = document.getElementById("close-button");
      button.addEventListener("click", () => {
        renderRoutine(routineOfTest);
      }); */

      const CUSTOM_NAMESPACE = "urn:x-cast:1F7E2448";
      const context = cast.framework.CastReceiverContext.getInstance();

      // Config to avoid auto-shutdown
      const options = new cast.framework.CastReceiverOptions();
      options.disableIdleTimeout = true;
      options.resumeSavedSession = true;

      // Listener for sender disconnection
      context.addEventListener(
        cast.framework.system.EventType.SENDER_DISCONNECTED,
        (event) => {
          console.log("Sender desconectado, cerrando...");
          if (context.getSenders().length === 0) {
            window.close();
          }
        },
      );

      // Listener for sent routines
      context.addCustomMessageListener(CUSTOM_NAMESPACE, (event) => {
        let routine = event.data.text;
        if (typeof routine === "string") {
          try {
            routine = JSON.parse(routine);
          } catch (e) {
            console.error("Error al parsear la rutina recibida:", e);
            return;
          }
        }
        renderRoutine(routine);
      });

      context.start(options);
    </script>
  </body>
</html>
