<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WOD Trainer Receiver</title>
    <!-- Mandatory loading of the Cast receiver framework -->
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <link rel="stylesheet" href="receiverStyles.css" />
  </head>
  <body>
    <div id="message-box">
      <img src="/assets/images/180logo.png" alt="Center Fitness Logo" />
      <h1>Gym Fitness Center</h1>
      <div id="waiting">Esperando rutina</div>
    </div>
    <div id="routine-container" class="is-hidden"></div>
    <!-- <button id="close-button">boton</button> -->

    <script>
      const routineOfTest = {
        durationMinutes: 36,
        category: "functional",
        name: "Nueva rutina",
        userId: "JcXXssklDiUbZqIn2f6paYa3mwn1",
        coachPhotoURL:
          "https://firebasestorage.googleapis.com/v0/b/gymblackboard.firebasestorage.app/o/profilePhotos%2FmoisesLopez.png?alt=media&token=12fe51bb-9ee0-44e3-acb0-712e7e554ad6",
        warmup: [
          {
            name: "Jumping Jacks",
            id: "pJuBnoeylFNqZ8rCsZH4",
            exerciseType: "warmup",
            sets: 2,
            reps: 20,
          },
          {
            reps: 20,
            id: "scntzjTW9G0p22SRqAse",
            name: "Balanceo de piernas",
            sets: 2,
            exerciseType: "warmup",
          },
        ],
        blocks: [
          {
            title: "Bloque 1",
            exercises: [
              {
                exerciseType: "functional",
                bodyPart: "chest",
                sets: 4,
                id: "Xuv4WBTEr233on8t5FZS",
                name: "Push-up",
                videoURL:
                  "https://firebasestorage.googleapis.com/v0/b/gymblackboard.firebasestorage.app/o/exercises%2FpushUp.mp4?alt=media&token=b19b89b3-f0a9-4eb1-9f44-58ee32316754",
                reps: 20,
              },
              {
                exerciseType: "functional",
                bodyPart: "chest",
                sets: 4,
                id: "Xuv4WBTEr233on8t5FZS",
                name: "Push-up",
                videoURL:
                  "https://firebasestorage.googleapis.com/v0/b/gymblackboard.firebasestorage.app/o/exercises%2FpushUp.mp4?alt=media&token=b19b89b3-f0a9-4eb1-9f44-58ee32316754",
                reps: 20,
              },
              {
                sets: 4,
                bodyPart: "back",
                id: "14gtBPclrLYmbwVgsIdd",
                reps: 50,
                exerciseType: "functional",
                name: "Remo con liga",
              },
            ],
            id: "1285bf39-c4f0-4b3c-9f80-96c2cbbf5f88",
          },
          {
            title: "Bloque 1",
            exercises: [
              {
                exerciseType: "functional",
                bodyPart: "chest",
                sets: 4,
                id: "Xuv4WBTEr233on8t5FZS",
                name: "Push-up",
                videoURL:
                  "https://firebasestorage.googleapis.com/v0/b/gymblackboard.firebasestorage.app/o/exercises%2FpushUp.mp4?alt=media&token=b19b89b3-f0a9-4eb1-9f44-58ee32316754",
                reps: 20,
              },
              {
                exerciseType: "functional",
                bodyPart: "chest",
                sets: 4,
                id: "Xuv4WBTEr233on8t5FZS",
                name: "Push-up",
                videoURL:
                  "https://firebasestorage.googleapis.com/v0/b/gymblackboard.firebasestorage.app/o/exercises%2FpushUp.mp4?alt=media&token=b19b89b3-f0a9-4eb1-9f44-58ee32316754",
                reps: 20,
              },
              {
                sets: 4,
                bodyPart: "back",
                id: "14gtBPclrLYmbwVgsIdd",
                reps: 50,
                exerciseType: "functional",
                name: "Remo con liga",
              },
            ],
            id: "1285bf39-c4f0-4b3c-9f80-96c2cbbf5f88",
          },
        ],
        exercisesAmount: 4,
        createdAt: {
          type: "firestore/timestamp/1.0",
          seconds: 1770991953,
          nanoseconds: 882000000,
        },
        coachName: "Moisés López",
        isFavorite: false,
        id: "qDTUpI1CvTA3P3xZEkcp",
      };

      function renderRoutine(routine) {
        const messageBox = document.getElementById("message-box");
        const routineContainer = document.getElementById("routine-container");
        messageBox.classList.add("is-hidden");
        routineContainer.classList.remove("is-hidden");

        routineContainer.innerHTML = `
        <div class="routine-header">
            <div class="coach-info">
              <img src="${routine.coachPhotoURL}" alt="${routine.coachName}" class="coach-photo" />
              <span class="coach-name">${routine.coachName}</span>
            </div>
          <img src="/assets/images/180logo.png" alt="Center Fitness Logo" />
        </div>

        
          <h1>${routine.name}</h1>
          <h2>${routine.exercisesAmount} Ejercicios - ${routine.durationMinutes} minutos</h2>
          <div class="warmup-section">
            <h2>Acondicionamiento</h2>
            <ul>
              ${routine.warmup
                .map(
                  (exercise) => `
                  <li>
                    <div>
                      <strong>${exercise.name}</strong> - ${exercise.sets} X ${exercise.reps} reps
                    </div>
                  </li>
                `,
                )
                .join("")}
            </ul>
          </div>
          ${routine.blocks
            .map(
              (block) => `
            <div class="block">
              <h3>${block.title}</h3>
              <ul>
                ${block.exercises
                  .map((exercise) => {
                    let videoHtml = "";
                    if (exercise.videoURL) {
                      videoHtml = `
                                    <div class="video-container">
                                        <video controls autoplay loop muted playsinline>
                                            <source src="${exercise.videoURL}" type="video/mp4">
                                        </video>
                                    </div>
                                `;
                    }
                    return `
                          <li>
                            <div>
                              <strong>${exercise.name}</strong> - ${exercise.sets} X ${exercise.reps} reps
                              </div>
                            <div>
                              
                              ${videoHtml}
                              </div>
                          </li>
                        `;
                  })
                  .join("")}
                  
                      </ul>
                    </div>
                  `,
            )
            .join("")}
                `;
      }

      /* const button = document.getElementById("close-button");
      button.addEventListener("click", () => {
        renderRoutine(routineOfTest);
      }); */

      const CUSTOM_NAMESPACE = "urn:x-cast:1F7E2448";
      const context = cast.framework.CastReceiverContext.getInstance();

      // Config to avoid auto-shutdown
      const options = new cast.framework.CastReceiverOptions();
      options.disableIdleTimeout = true;
      options.resumeSavedSession = true;

      // Listener for sender disconnection
      context.addEventListener(
        cast.framework.system.EventType.SENDER_DISCONNECTED,
        (event) => {
          console.log("Sender desconectado, cerrando...");
          if (context.getSenders().length === 0) {
            window.close();
          }
        },
      );

      // Listener for sent routines
      context.addCustomMessageListener(CUSTOM_NAMESPACE, (event) => {
        let routine = event.data.text;
        if (typeof routine === "string") {
          try {
            routine = JSON.parse(routine);
          } catch (e) {
            console.error("Error al parsear la rutina recibida:", e);
            return;
          }
        }
        renderRoutine(routine);
      });

      context.start(options);
    </script>
  </body>
</html>
